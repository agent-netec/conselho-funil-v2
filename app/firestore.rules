rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Verifica se o usuário é membro da agência
    function getAgencyMember(agencyId) {
      return get(/databases/$(database)/documents/agencies/$(agencyId)/members/$(request.auth.uid)).data;
    }

    function isAgencyMember(agencyId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/agencies/$(agencyId)/members/$(request.auth.uid));
    }

    function isAgencyAdmin(agencyId) {
      return isAgencyMember(agencyId) && getAgencyMember(agencyId).role == 'admin';
    }

    function isAgencyManager(agencyId) {
      return isAgencyMember(agencyId) && getAgencyMember(agencyId).role == 'manager';
    }

    function isAgencyViewer(agencyId) {
      return isAgencyMember(agencyId) && getAgencyMember(agencyId).role == 'viewer';
    }

    // Regra de Ouro: Isolamento de Cliente para Managers
    function canAccessClient(agencyId, clientId) {
      let member = getAgencyMember(agencyId);
      return isAgencyAdmin(agencyId) || 
             (isAgencyManager(agencyId) && (member.assignedClients == null || clientId in member.assignedClients)) ||
             (isAgencyViewer(agencyId) && (member.assignedClients == null || clientId in member.assignedClients));
    }

    // ============================================
    // COLLECTIONS
    // ============================================

    // Users collection
    match /users/{userId} {
      allow read, write: if isUser(userId);
    }
    
    // Agencies Root
    match /agencies/{agencyId} {
      allow read: if isAgencyMember(agencyId);
      allow write: if isAgencyAdmin(agencyId);

      // Members subcollection
      match /members/{memberId} {
        allow read: if isAgencyMember(agencyId);
        allow write: if isAgencyAdmin(agencyId);
      }

      // Clients subcollection (Isolamento de Cliente)
      match /clients/{clientId} {
        allow read: if isAgencyMember(agencyId) && canAccessClient(agencyId, clientId);
        allow write: if isAgencyAdmin(agencyId) || (isAgencyManager(agencyId) && canAccessClient(agencyId, clientId));
        
        // Dados do Cliente (Funis, Eventos, etc. dentro do path do cliente)
        match /{allChildren=**} {
          allow read: if isAgencyMember(agencyId) && canAccessClient(agencyId, clientId);
          allow write: if isAgencyAdmin(agencyId) || (isAgencyManager(agencyId) && canAccessClient(agencyId, clientId));
        }
      }
    }

    // Legacy/Global Collections (Migrar para agency/client path no futuro)
    // Por enquanto, bloqueamos acesso global se não for admin do sistema ou se não houver vínculo explícito
    
    match /tenants/{tenantId} {
      allow read, write: if isAuthenticated() && (resource == null || resource.data.ownerId == request.auth.uid);
    }
    
    match /funnels/{funnelId} {
      // Se o funil tiver agencyId/clientId, validamos. Se não, apenas o dono (userId)
      allow read, write: if isAuthenticated() && (
        (resource.data.agencyId != null && canAccessClient(resource.data.agencyId, resource.data.clientId)) ||
        (resource.data.userId == request.auth.uid)
      );
    }

    match /brands/{brandId} {
      allow read, write: if isAuthenticated() && (
        (resource.data.agencyId != null && canAccessClient(resource.data.agencyId, resource.data.clientId)) ||
        (resource.data.userId == request.auth.uid)
      );

      // Offer Lab — subcollection de ofertas da brand
      match /offers/{offerId} {
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/brands/$(brandId)).data.agencyId != null
            ? canAccessClient(
                get(/databases/$(database)/documents/brands/$(brandId)).data.agencyId,
                get(/databases/$(database)/documents/brands/$(brandId)).data.clientId
              )
            : get(/databases/$(database)/documents/brands/$(brandId)).data.userId == request.auth.uid
        );
        allow write: if isAuthenticated() && (
          get(/databases/$(database)/documents/brands/$(brandId)).data.agencyId != null
            ? (isAgencyAdmin(get(/databases/$(database)/documents/brands/$(brandId)).data.agencyId) ||
               (isAgencyManager(get(/databases/$(database)/documents/brands/$(brandId)).data.agencyId) &&
                canAccessClient(
                  get(/databases/$(database)/documents/brands/$(brandId)).data.agencyId,
                  get(/databases/$(database)/documents/brands/$(brandId)).data.clientId
                )))
            : get(/databases/$(database)/documents/brands/$(brandId)).data.userId == request.auth.uid
        );
      }
    }

    // Knowledge base (Public Read, Admin Write via custom claims)
    match /knowledge/{chunkId} {
      allow read: if true;
      allow write: if isAuthenticated() && isAgencyAdmin(request.auth.token.agencyId);
    }

    // R-1.2: Library — Public read, write restricted to owner
    match /library/{templateId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Bloqueio Global de Segurança (NUNCA deixar allow true aqui)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
