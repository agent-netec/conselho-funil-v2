module.exports=[193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},814747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},224361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},605365,(e,t,r)=>{t.exports=e.x("process",()=>require("process"))},446786,(e,t,r)=>{t.exports=e.x("os",()=>require("os"))},254799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},921517,(e,t,r)=>{t.exports=e.x("http",()=>require("http"))},688947,(e,t,r)=>{t.exports=e.x("stream",()=>require("stream"))},522734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},792509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},474065,e=>{"use strict";let t={container:{get:()=>({})}},r={currentUser:null,onAuthStateChanged:()=>()=>{},signOut:async()=>{},getApp:()=>({container:t.container}),app:{container:t.container},INTERNAL:t,container:t.container,collection:()=>({doc:()=>({get:async()=>({exists:()=>!1})})}),doc:()=>({get:async()=>({exists:()=>!1})}),ref:()=>({put:async()=>({})})};e.g.firebase=e.g.firebase||{INTERNAL:t},e.g.firebaseApp=e.g.firebaseApp||r,e.g._firebaseApp=e.g._firebaseApp||r,e.g.firebaseInternalContainer=t.container,process.env.NEXT_PHASE,e.s(["db",0,r,"storage",0,r])},653137,e=>{"use strict";e.i(564153);var t=e.i(918042);let r={maxRetries:3,initialDelay:1e3,maxDelay:1e4,factor:2},a=["aborted","deadline-exceeded","resource-exhausted","unavailable","internal"];async function n(e,o={}){let s,{maxRetries:i,initialDelay:d,maxDelay:l,factor:c}={...r,...o},u=d;for(let r=0;r<=i;r++)try{return await e()}catch(e){if(s=e,!(e instanceof t.FirestoreError&&a.includes(e.code))||r===i)break;console.warn(`[Resilience] Falha na opera\xe7\xe3o (tentativa ${r+1}/${i+1}). Erro: ${e.code}. Tentando novamente em ${u}ms...`),await new Promise(e=>setTimeout(e,u)),u=Math.min(u*c,l)}throw console.error("[Resilience] Operação falhou permanentemente após retries.",s),s}e.s(["withResilience",()=>n])},653936,e=>{"use strict";var t=e.i(346414);e.i(564153);var r=e.i(918042),a=e.i(474065);function n(){let e=(process.env.NEXT_PUBLIC_GOOGLE_AI_API_KEY??"").trim(),t=(process.env.GOOGLE_AI_API_KEY??"").trim();return e||t}async function o(e){let t=new TextEncoder().encode(e.trim().toLowerCase());return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function s(e){let t=n();if(!t)throw Error("GOOGLE_AI_API_KEY not configured for embeddings");let s=Date.now(),i=await o(e);try{let e=(0,r.doc)(a.db,"query_cache",i),t=await (0,r.getDoc)(e);if(t.exists()){let e=t.data();if(!(r.Timestamp.now().toMillis()-e.createdAt.toMillis()>2592e6))return console.log(`[Embeddings] Cache HIT for key: ${i.substring(0,8)} (${Date.now()-s}ms)`),e.embedding}}catch(e){console.warn("[Embeddings] Cache read error:",e)}try{console.log("[Embeddings] Calling text-embedding-004 with dimensionality: 768");let n=await fetch("https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify({model:"models/text-embedding-004",content:{parts:[{text:e}]},outputDimensionality:768})});if(!n.ok){let e=await n.text();throw Error(`Embedding API failed: ${n.status} ${e}`)}let o=await n.json(),d=o?.embedding?.values;if(!Array.isArray(d))throw Error("Embedding API returned no values");let l=(0,r.doc)(a.db,"query_cache",i);return(0,r.setDoc)(l,{query:e.substring(0,500),embedding:d,createdAt:r.Timestamp.now()}).catch(e=>console.error("[Embeddings] Cache write error:",e)),console.log(`[Embeddings] Cache MISS - API called (${Date.now()-s}ms)`),d}catch(e){throw console.error("[Embeddings] Error generating embedding:",e),e}}async function i(e){let s=Date.now(),i=Array(e.length).fill(null),d=[],l=[],c=r.Timestamp.now().toMillis();for(let t=0;t<e.length;t++){let n=e[t],s=await o(n);try{let e=(0,r.doc)(a.db,"query_cache",s),n=await (0,r.getDoc)(e);if(n.exists()){let e=n.data();if(!(c-e.createdAt.toMillis()>2592e6)){i[t]=e.embedding;continue}}}catch(e){}d.push(t),l.push(n)}if(0===l.length)return console.log(`[Embeddings] Batch Cache HIT (100%) - ${e.length} items (${Date.now()-s}ms)`),i;let u=n();if(!u)throw Error("GOOGLE_AI_API_KEY not configured for embeddings");new t.GoogleGenerativeAI(u).getGenerativeModel({model:"text-embedding-004"});try{console.log(`[Embeddings] Batch Cache MISS - Calling API for ${l.length}/${e.length} items`);let t=[];for(let e=0;e<l.length;e+=90){let r=l.slice(e,e+90);console.log(`[Embeddings] Processing API sub-batch ${e/90+1} (${r.length} items)`);let a=await fetch("https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:batchEmbedContents",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":u},body:JSON.stringify({requests:r.map(e=>({model:"models/text-embedding-004",content:{parts:[{text:e}]},outputDimensionality:768}))})});if(!a.ok){let e=await a.text();throw Error(`Batch Embedding API failed: ${a.status} ${e}`)}let n=await a.json();if(!n.embeddings||!Array.isArray(n.embeddings))throw Error("Batch Embedding API returned invalid format");t.push(...n.embeddings.map(e=>e.values))}for(let e=0;e<d.length;e++){let n=d[e],s=t[e],c=l[e];i[n]=s;let u=await o(c),p=(0,r.doc)(a.db,"query_cache",u);(0,r.setDoc)(p,{query:c.substring(0,500),embedding:s,createdAt:r.Timestamp.now()}).catch(e=>console.error("[Embeddings] Cache write error:",e))}return console.log(`[Embeddings] Batch completed (${Date.now()-s}ms)`),i}catch(e){throw console.error("[Embeddings] Error generating batch embeddings:",e),e}}e.s(["generateEmbedding",()=>s,"generateEmbeddingsBatch",()=>i])},912714,(e,t,r)=>{t.exports=e.x("node:fs/promises",()=>require("node:fs/promises"))},500874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},750227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},666680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},81111,(e,t,r)=>{t.exports=e.x("node:stream",()=>require("node:stream"))},478500,(e,t,r)=>{t.exports=e.x("node:async_hooks",()=>require("node:async_hooks"))},600575,75621,e=>{"use strict";e.i(564153);var t=e.i(918042),r=e.i(474065);function a(e,t=1500,r=200){if(!e)return[];if(t<=r)throw Error("O tamanho do chunk (size) deve ser maior que a sobreposição (overlap).");let n=[],o=0;for(;o<e.length;){let a=o+t;if(a<e.length){let r=Math.floor(.2*t),n=Math.max(e.lastIndexOf(" ",a),e.lastIndexOf("\n",a));n>a-r&&(a=n)}else a=e.length;let s=e.slice(o,a).trim();if(s&&n.push(s),(o=a-r)>=e.length||a>=e.length)break;o<0&&(o=0)}return n}e.s(["createChunks",()=>a],75621);var n=e.i(653936),o=e.i(328668);async function s(s,d,l){try{let{upsertToPinecone:c}=await e.A(84617),u=await (0,o.getAsset)(s);if(!u)throw Error("Asset não encontrado");let p=l||`brand-${u.brandId}`;await (0,o.updateAssetStatus)(s,"processing");let h=a(d,1500,200);if(!h.length)throw Error("Nenhum chunk gerado");let g=await (0,n.generateEmbeddingsBatch)(h),m=t.Timestamp.now(),f=h.map((e,t)=>({id:`${s}-chunk-${t+1}`,brandId:u.brandId,assetId:s,userId:u.userId,content:e,embedding:g[t],order:t,createdAt:m,metadata:{sourceType:u.metadata?.sourceType??"text",sourceUrl:u.metadata?.sourceUrl??"",originalName:u.metadata?.originalName??u.name,isApprovedForAI:u.metadata?.isApprovedForAI??u.isApprovedForAI??!1,extractedAt:m.toDate().toISOString(),processingMethod:"text-direct"}}));await i(s,f);let x=f.map(e=>({id:e.id,values:e.embedding??[],metadata:{brandId:e.brandId,assetId:e.assetId,originalName:e.metadata?.originalName||"",sourceType:e.metadata?.sourceType||"text",sourceUrl:e.metadata?.sourceUrl||"",processingMethod:"text-direct",content:e.content}}));await c(x,{namespace:p}),await (0,o.updateAssetStatus)(s,"ready"),await (0,t.updateDoc)((0,t.doc)(r.db,"brand_assets",s),{chunkCount:f.length,processedAt:m,extractedText:d})}catch(e){throw console.error(`[processAssetText] Erro no asset ${s}:`,e),await (0,o.updateAssetStatus)(s,"error",e.message),e}}async function i(e,a){if(!a.length)return;let n=(0,t.collection)(r.db,"brand_assets",e,"chunks"),o=await (0,t.getDocs)(n);if(!o.empty){let e=o.docs;for(let a=0;a<e.length;a+=100){let n=(0,t.writeBatch)(r.db);e.slice(a,a+100).forEach(e=>n.delete(e.ref)),await n.commit()}}for(let e=0;e<a.length;e+=50){let o=(0,t.writeBatch)(r.db),s=a.slice(e,e+50);s.forEach(e=>{let r=(0,t.doc)(n,e.id);o.set(r,e)}),await o.commit(),console.log(`[saveAssetChunks] Lote de ${s.length} chunks salvo (${e+s.length}/${a.length})`)}}e.s(["processAssetText",()=>s,"saveAssetChunks",()=>i],600575)},640074,e=>{"use strict";var t=e.i(906661),r=e.i(276806),a=e.i(981990),n=e.i(707163),o=e.i(893013),s=e.i(416393),i=e.i(418829),d=e.i(907831),l=e.i(787414),c=e.i(251948),u=e.i(254140),p=e.i(847739),h=e.i(877290),g=e.i(195428),m=e.i(114365),f=e.i(193695);e.i(495983);var x=e.i(56931),w=e.i(758910),b=e.i(951615);e.i(564153);var A=e.i(918042),E=e.i(75621),v=e.i(653936),y=e.i(413263),I=e.i(328668),R=e.i(600575),k=e.i(280465);async function C(t){if(t.extractedText?.trim())return t.extractedText;if(!t.url)throw Error("Asset sem texto extraído e sem URL para processamento.");if("url"===t.type){console.log(`[Worker] Detectada URL: ${t.url}. Iniciando scraping inteligente...`);let e=await (0,k.extractContentFromUrl)(t.url);if(e.error)throw Error(`Falha no scraping da URL: ${e.error}`);return e.content}let r=await fetch(t.url);if((r.headers.get("content-type")||"").includes("application/pdf"))try{let t=await e.A(169140),a=t.default||t,n=await r.arrayBuffer(),o=await a(b.Buffer.from(n));if(o?.text)return o.text}catch(e){return console.warn("[Worker] Falha ao extrair PDF, retornando texto vazio.",e),""}return await r.text()}async function _(e,t){let r=await (0,I.fetchBrandAsset)(e);if(!r)throw Error("Asset não encontrado.");if(!0!==r.isApprovedForAI)throw Error("Asset não aprovado para IA.");await (0,I.updateBrandAsset)(r.id,{status:"processing",processingError:""});try{let e,a=await C(r);if(!a?.trim())throw Error("Texto extraído vazio ou inválido.");let n=(0,E.createChunks)(a,1500,200);if(!n.length)throw Error("Nenhum chunk gerado a partir do texto.");let o=await (0,v.generateEmbeddingsBatch)(n);if(o.length!==n.length)throw Error("Falha ao gerar embeddings para todos os chunks.");let s=(e=A.Timestamp.now(),n.map((t,a)=>({id:`${r.id}-chunk-${a+1}`,brandId:r.brandId,assetId:r.id,userId:r.userId,content:t,embedding:o[a],order:a,createdAt:e,metadata:{sourceType:r.metadata?.sourceType??"text",sourceUrl:r.metadata?.sourceUrl??r.url??"",originalName:r.metadata?.originalName??r.originalName??r.name,isApprovedForAI:r.metadata?.isApprovedForAI??r.isApprovedForAI??!1,extractedAt:r.metadata?.extractedAt??e.toDate().toISOString(),processingMethod:r.metadata?.processingMethod??"worker-v2"}})));await (0,R.saveAssetChunks)(r.id,s);let i=s.map(e=>({id:e.id,values:e.embedding??[],metadata:{brandId:e.brandId,assetId:e.assetId,originalName:e.metadata?.originalName||"",sourceType:e.metadata?.sourceType||"text",sourceUrl:e.metadata?.sourceUrl||"",processingMethod:"worker-v2",content:e.content}})),d=t||`brand-${r.brandId}`,l=await (0,y.upsertToPinecone)(i,{namespace:d});return await (0,I.updateBrandAsset)(r.id,{status:"ready",chunkCount:s.length,processedAt:A.Timestamp.now(),processingError:""}),{assetId:r.id,chunkCount:s.length,pineconeUpserted:l.upserted}}catch(t){let e=t instanceof Error?t.message:"Erro desconhecido no worker.";throw await (0,I.updateBrandAsset)(r.id,{status:"error",processingError:e,processedAt:A.Timestamp.now()}),t}}async function T(e){try{let t=await e.json().catch(()=>null),r=t?.assetId,a=t?.namespace;if(!r)return w.NextResponse.json({ok:!1,error:"assetId é obrigatório."},{status:400});console.log(`[Ingest API] Iniciando worker para asset: ${r} (namespace: ${a||"default"})`);let n=await _(r,a);return w.NextResponse.json({ok:!0,...n},{status:200})}catch(t){let e=t?.message||"Erro desconhecido ao processar asset.";return console.error("[Ingest API] Falha no processamento:",e),w.NextResponse.json({ok:!1,error:e,details:t?.stack},{status:500})}}e.s(["POST",()=>T,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],261241);var P=e.i(261241);let N=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/ingest/process-worker/route",pathname:"/api/ingest/process-worker",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/CURSOR/CONSELHO DE FUNIL/app/src/app/api/ingest/process-worker/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:O,workUnitAsyncStorage:q,serverHooks:S}=N;function $(){return(0,a.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:q})}async function D(e,t,a){N.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/ingest/process-worker/route";w=w.replace(/\/index$/,"")||"/";let b=await N.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!b)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:A,params:E,nextConfig:v,parsedUrl:y,isDraftMode:I,prerenderManifest:R,routerServerContext:k,isOnDemandRevalidate:C,revalidateOnlyGenerated:_,resolvedPathname:T,clientReferenceManifest:P,serverActionsManifest:O}=b,q=(0,i.normalizeAppPath)(w),S=!!(R.dynamicRoutes[q]||R.routes[T]),$=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,y,!1):t.end("This page could not be found"),null);if(S&&!I){let e=!!R.routes[T],t=R.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await $();throw new f.NoFallbackError}}let D=null;!S||N.isDev||I||(D="/index"===(D=T)?"/":D);let U=!0===N.isDev||!S,j=S&&!U;O&&P&&(0,s.setManifestsSingleton)({page:w,clientReferenceManifest:P,serverActionsManifest:O});let M=e.method||"GET",F=(0,o.getTracer)(),B=F.getActiveScopeSpan(),H={params:E,prerenderManifest:R,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>N.onRequestError(e,t,a,n,k)},sharedContext:{buildId:A}},L=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(L,(0,l.signalFromNodeResponse)(t));try{let s=async e=>N.handle(K,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${w}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var o,d;let l=async({previousCacheEntry:r})=>{try{if(!i&&C&&_&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(n);e.fetchMetrics=H.renderOpts.fetchMetrics;let d=H.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=H.renderOpts.collectedTags;if(!S)return await (0,p.sendResponse)(L,G,o,H.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,a=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,k),t}},c=await N.handleResponse({req:e,nextConfig:v,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:R,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:_,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:i});if(!S)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",C?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&S||f.delete(m.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(L,G,new Response(c.value.body,{headers:f,status:c.value.status||200})),null};B?await d(B):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${M} ${w}`,kind:o.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof f.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,k),S)throw t;return await (0,p.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>$,"routeModule",()=>N,"serverHooks",()=>S,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>q],640074)},465660,e=>{e.v(t=>Promise.all(["server/chunks/5c86f_@pinecone-database_pinecone_dist_version_json_56283c30._.js","server/chunks/5c86f_@pinecone-database_pinecone_dist_b1d5c4a9._.js"].map(t=>e.l(t))).then(()=>t(432229)))},84617,e=>{e.v(e=>Promise.resolve().then(()=>e(413263)))},169140,e=>{e.v(t=>Promise.all(["server/chunks/5c86f_pdf-parse_dist_pdf-parse_esm_index_c400f343.js"].map(t=>e.l(t))).then(()=>t(26160)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__45c66f78._.js.map