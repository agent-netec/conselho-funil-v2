module.exports=[392977,e=>{"use strict";var t=e.i(758910),r=e.i(254799),a=e.i(813106);class n extends Error{status;constructor(e,t){super(t),this.status=e,this.name="ApiError"}}function o(e,t,a,n){let o=a=>{let n="sha256="+(0,r.createHmac)("sha256",a).update(e).digest("hex");try{return(0,r.timingSafeEqual)(Buffer.from(t),Buffer.from(n))}catch{return!1}};try{if(o(a))return!0;if(n&&o(n))return console.log("[Security] Webhook validado via chave secundária (Graceful Rotation)"),!0;return!1}catch(e){return console.error("[Security] Erro na validação de assinatura:",e),!1}}async function i(e){let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))throw new n(401,"Autenticação necessária (Bearer token ausente)");let r=t.split("Bearer ")[1];try{let e=(process.env.NEXT_PUBLIC_FIREBASE_API_KEY??"").trim();if(!e)throw new n(500,"Configuração do Firebase ausente (API Key)");let t=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:r})});if(!t.ok){let e=await t.json();throw console.error("Firebase Auth REST API Error:",e),new n(401,"Token de autenticação inválido ou expirado")}let o=await t.json(),i=o.users?.[0]?.localId;if(!i)throw new n(401,"Usuário não encontrado no provedor de auth");let s=await (0,a.getUser)(i);if(!s)throw new n(403,"Perfil de usuário não encontrado no banco de dados");if("admin"!==s.role)throw new n(403,"Acesso negado: Requer privilégios de administrador");return s}catch(e){if(e instanceof n)throw e;throw console.error("Security Verification Error:",e),new n(500,"Erro interno na verificação de segurança")}}function s(e){return e instanceof n?t.NextResponse.json({error:e.message},{status:e.status}):(console.error("Unhandled Security Error:",e),t.NextResponse.json({error:"Erro de segurança não especificado"},{status:500}))}e.s(["handleSecurityError",()=>s,"validateWebhookSignature",()=>o,"verifyAdminRole",()=>i])},653936,e=>{"use strict";var t=e.i(346414);e.i(564153);var r=e.i(918042),a=e.i(474065);function n(){let e=(process.env.NEXT_PUBLIC_GOOGLE_AI_API_KEY??"").trim(),t=(process.env.GOOGLE_AI_API_KEY??"").trim();return e||t}async function o(e){let t=new TextEncoder().encode(e.trim().toLowerCase());return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function i(e){let t=n();if(!t)throw Error("GOOGLE_AI_API_KEY not configured for embeddings");let i=Date.now(),s=await o(e);try{let e=(0,r.doc)(a.db,"query_cache",s),t=await (0,r.getDoc)(e);if(t.exists()){let e=t.data();if(!(r.Timestamp.now().toMillis()-e.createdAt.toMillis()>2592e6))return console.log(`[Embeddings] Cache HIT for key: ${s.substring(0,8)} (${Date.now()-i}ms)`),e.embedding}}catch(e){console.warn("[Embeddings] Cache read error:",e)}try{console.log("[Embeddings] Calling text-embedding-004 with dimensionality: 768");let n=await fetch("https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify({model:"models/text-embedding-004",content:{parts:[{text:e}]},outputDimensionality:768})});if(!n.ok){let e=await n.text();throw Error(`Embedding API failed: ${n.status} ${e}`)}let o=await n.json(),l=o?.embedding?.values;if(!Array.isArray(l))throw Error("Embedding API returned no values");let d=(0,r.doc)(a.db,"query_cache",s);return(0,r.setDoc)(d,{query:e.substring(0,500),embedding:l,createdAt:r.Timestamp.now()}).catch(e=>console.error("[Embeddings] Cache write error:",e)),console.log(`[Embeddings] Cache MISS - API called (${Date.now()-i}ms)`),l}catch(e){throw console.error("[Embeddings] Error generating embedding:",e),e}}async function s(e){let i=Date.now(),s=Array(e.length).fill(null),l=[],d=[],c=r.Timestamp.now().toMillis();for(let t=0;t<e.length;t++){let n=e[t],i=await o(n);try{let e=(0,r.doc)(a.db,"query_cache",i),n=await (0,r.getDoc)(e);if(n.exists()){let e=n.data();if(!(c-e.createdAt.toMillis()>2592e6)){s[t]=e.embedding;continue}}}catch(e){}l.push(t),d.push(n)}if(0===d.length)return console.log(`[Embeddings] Batch Cache HIT (100%) - ${e.length} items (${Date.now()-i}ms)`),s;let u=n();if(!u)throw Error("GOOGLE_AI_API_KEY not configured for embeddings");new t.GoogleGenerativeAI(u).getGenerativeModel({model:"text-embedding-004"});try{console.log(`[Embeddings] Batch Cache MISS - Calling API for ${d.length}/${e.length} items`);let t=[];for(let e=0;e<d.length;e+=90){let r=d.slice(e,e+90);console.log(`[Embeddings] Processing API sub-batch ${e/90+1} (${r.length} items)`);let a=await fetch("https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:batchEmbedContents",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":u},body:JSON.stringify({requests:r.map(e=>({model:"models/text-embedding-004",content:{parts:[{text:e}]},outputDimensionality:768}))})});if(!a.ok){let e=await a.text();throw Error(`Batch Embedding API failed: ${a.status} ${e}`)}let n=await a.json();if(!n.embeddings||!Array.isArray(n.embeddings))throw Error("Batch Embedding API returned invalid format");t.push(...n.embeddings.map(e=>e.values))}for(let e=0;e<l.length;e++){let n=l[e],i=t[e],c=d[e];s[n]=i;let u=await o(c),p=(0,r.doc)(a.db,"query_cache",u);(0,r.setDoc)(p,{query:c.substring(0,500),embedding:i,createdAt:r.Timestamp.now()}).catch(e=>console.error("[Embeddings] Cache write error:",e))}return console.log(`[Embeddings] Batch completed (${Date.now()-i}ms)`),s}catch(e){throw console.error("[Embeddings] Error generating batch embeddings:",e),e}}e.s(["generateEmbedding",()=>i,"generateEmbeddingsBatch",()=>s])},413263,e=>{"use strict";function t(){let e=process.env.PINECONE_API_KEY,t=process.env.PINECONE_INDEX||process.env.PINECONE_INDEX_NAME||"cf-dev-assets",r=process.env.PINECONE_HOST||process.env.PINECONE_HOST_URL;if(!e)throw Error("PINECONE_API_KEY ausente.");return{apiKey:e,indexName:t,host:r}}let r=null,a=null;async function n(){if(r)return r;let{apiKey:a}=t(),{Pinecone:n}=await e.A(465660);return r=new n({apiKey:a})}async function o(){if(a)return a;let{indexName:e,host:r}=t(),o=await n();return o?a=r?o.index(e,r):o.index(e):null}async function i(e,t={}){if(!e?.length)return{upserted:0};let r=await o();if(!r)return{upserted:0};let a=t.namespace?r.namespace(t.namespace):r;return await a.upsert(e),{upserted:e.length}}async function s(e){let{vector:t,topK:r=10,namespace:a,filter:n}=e,i=await o();if(!i)return{matches:[]};let s=a?i.namespace(a):i;return await s.query({vector:t,topK:r,filter:n,includeMetadata:!0})}async function l(){let{indexName:e}=t(),r=await o(),a=await n();if(!r||!a)return null;let i=await r.describeIndexStats();return await a.describeIndex(e),{status:"connected",index:e,totalVectors:i.totalRecordCount??0}}e.s(["checkPineconeHealth",()=>l,"getPineconeClient",()=>n,"getPineconeIndex",()=>o,"queryPinecone",()=>s,"upsertToPinecone",()=>i])},569157,e=>{"use strict";e.i(564153);var t=e.i(918042),r=e.i(474065);e.i(653137),e.i(653936),e.i(413263);var a=e.i(317036);class n{static getCollectionPath(e){return`brands/${e}/secrets`}static async saveToken(e,n){let o=(0,t.doc)(r.db,this.getCollectionPath(e),`token_${n.provider}`),i={...n,accessToken:(0,a.encrypt)(n.accessToken),refreshToken:n.refreshToken?(0,a.encrypt)(n.refreshToken):void 0,updatedAt:t.Timestamp.now()};await (0,t.setDoc)(o,i)}static async getToken(e,n){let o=(0,t.doc)(r.db,this.getCollectionPath(e),`token_${n}`),i=await (0,t.getDoc)(o);if(!i.exists())return null;let s=i.data();return{...s,accessToken:(0,a.decrypt)(s.accessToken),refreshToken:s.refreshToken?(0,a.decrypt)(s.refreshToken):void 0}}static isTokenExpiring(e){let t=Date.now();return e.expiresAt.toMillis()-t<864e5}}e.s(["MonaraTokenVault",()=>n],569157)},295162,e=>{"use strict";var t=e.i(906661),r=e.i(276806),a=e.i(981990),n=e.i(707163),o=e.i(893013),i=e.i(416393),s=e.i(418829),l=e.i(907831),d=e.i(787414),c=e.i(251948),u=e.i(254140),p=e.i(847739),h=e.i(877290),m=e.i(195428),g=e.i(114365),f=e.i(193695);e.i(495983);var w=e.i(56931),E=e.i(758910),b=e.i(392977),y=e.i(569157);e.i(564153);var v=e.i(918042);class A{static normalize(e){let{platform:t,payload:r}=e;switch(t){case"instagram":return this.normalizeInstagram(r);case"meta":return this.normalizeMeta(r);default:throw Error(`Plataforma ${t} n\xe3o suportada pelo normalizador.`)}}static normalizeInstagram(e){let t=e.entry?.[0],r=t?.messaging?.[0],a=t?.changes?.[0]?.value;if(r)return{leadId:r.sender.id,interaction:{type:"dm_received",platform:"instagram",timestamp:v.Timestamp.now(),metadata:{text:r.message?.text}}};if(a)return{leadId:a.from.id,interaction:{type:"comment_made",platform:"instagram",timestamp:v.Timestamp.now(),metadata:{text:a.text,mediaId:a.media?.id}}};throw Error("Payload Instagram inválido ou não reconhecido.")}static normalizeMeta(e){let t=e.entry?.[0]?.changes?.[0];if(t?.field==="leadgen")return{leadId:t.value.leadgen_id,interaction:{type:"ad_click",platform:"meta",timestamp:v.Timestamp.now(),metadata:{formId:t.value.form_id}}};throw Error("Payload Meta Ads inválido ou não reconhecido.")}}var R=e.i(474065);class x{static async getLeadContext(e,t){let r=(0,v.doc)(R.db,`brands/${e}/leads`,t),a=await (0,v.getDoc)(r);return a.exists()?{id:a.id,...a.data()}:null}static async processInteraction(e,t,r){let a=(0,v.doc)(R.db,`brands/${e}/leads`,t),n=await this.getLeadContext(e,t);if(!n){let t={brandId:e,currentAwareness:"UNAWARE",lastInteraction:r,tags:[],score:10,metadata:{},updatedAt:v.Timestamp.now()};await (0,v.setDoc)(a,t);return}let o=n.currentAwareness,i=n.score,s=5;"ad_click"===r.type&&(s=10),"dm_received"===r.type&&(s=15);let l=i+s;l>80?o="MOST_AWARE":l>60?o="PRODUCT_AWARE":l>40?o="SOLUTION_AWARE":l>20&&(o="PROBLEM_AWARE"),await (0,v.updateDoc)(a,{currentAwareness:o,lastInteraction:r,score:l,updatedAt:v.Timestamp.now()});let d=(0,v.collection)(R.db,`brands/${e}/leads/${t}/events`);await (0,v.addDoc)(d,{...r,awarenessAtTime:o,timestamp:v.Timestamp.now()})}}async function _(e){let t=e.nextUrl.pathname.split("/").pop(),r=e.nextUrl.searchParams.get("brandId");if(!r)return E.NextResponse.json({error:"brandId is required"},{status:400});try{let a=await e.text(),n=e.headers.get("x-hub-signature-256")||e.headers.get("x-hub-signature"),o=await y.MonaraTokenVault.getToken(r,"instagram"===t?"meta":t),i=o?.metadata?.clientSecret;if(!i)return console.error(`[Webhook] ClientSecret not found for brand ${r} on platform ${t}`),E.NextResponse.json({error:"Configuration missing"},{status:500});if(n&&!(0,b.validateWebhookSignature)(a,n,i))return E.NextResponse.json({error:"Invalid signature"},{status:401});let s=JSON.parse(a),{leadId:l,interaction:d}=A.normalize({platform:t,brandId:r,payload:s});return await x.processInteraction(r,l,d),E.NextResponse.json({success:!0})}catch(e){return console.error(`[Webhook Error] ${t}:`,e),E.NextResponse.json({error:"Internal processing error",details:e.message},{status:500})}}async function I(e){let{searchParams:t}=new URL(e.url),r=t.get("hub.mode"),a=t.get("hub.verify_token"),n=t.get("hub.challenge");return"subscribe"===r&&a?new E.NextResponse(n,{status:200}):E.NextResponse.json({error:"Forbidden"},{status:403})}e.s(["GET",()=>I,"POST",()=>_],712050);var T=e.i(712050);let C=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/webhooks/dispatcher/route",pathname:"/api/webhooks/dispatcher",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/CURSOR/CONSELHO DE FUNIL/app/src/app/api/webhooks/dispatcher/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:P,workUnitAsyncStorage:k,serverHooks:N}=C;function O(){return(0,a.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:k})}async function S(e,t,a){C.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/webhooks/dispatcher/route";E=E.replace(/\/index$/,"")||"/";let b=await C.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!b)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:v,nextConfig:A,parsedUrl:R,isDraftMode:x,prerenderManifest:_,routerServerContext:I,isOnDemandRevalidate:T,revalidateOnlyGenerated:P,resolvedPathname:k,clientReferenceManifest:N,serverActionsManifest:O}=b,S=(0,s.normalizeAppPath)(E),D=!!(_.dynamicRoutes[S]||_.routes[k]),$=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,R,!1):t.end("This page could not be found"),null);if(D&&!x){let e=!!_.routes[k],t=_.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await $();throw new f.NoFallbackError}}let U=null;!D||C.isDev||x||(U="/index"===(U=k)?"/":U);let M=!0===C.isDev||!D,q=D&&!M;O&&N&&(0,i.setManifestsSingleton)({page:E,clientReferenceManifest:N,serverActionsManifest:O});let j=e.method||"GET",H=(0,o.getTracer)(),B=H.getActiveScopeSpan(),L={params:v,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>C.onRequestError(e,t,a,n,I)},sharedContext:{buildId:y}},K=new l.NodeNextRequest(e),G=new l.NodeNextResponse(t),F=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let i=async e=>C.handle(F,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${j} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${E}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var o,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&T&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!D)return await (0,p.sendResponse)(K,G,o,L.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:T})},!1,I),t}},c=await C.handleResponse({req:e,nextConfig:A,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:P,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!D)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&D||f.delete(g.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(K,G,new Response(c.value.body,{headers:f,status:c.value.status||200})),null};B?await l(B):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${j} ${E}`,kind:o.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:T})},!1,I),D)throw t;return await (0,p.sendResponse)(K,G,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>O,"routeModule",()=>C,"serverHooks",()=>N,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>k],295162)},465660,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__a13a3d25._.js","server/chunks/5c86f_@pinecone-database_pinecone_dist_b1d5c4a9._.js"].map(t=>e.l(t))).then(()=>t(432229)))}];

//# sourceMappingURL=OneDrive_Desktop_CURSOR_CONSELHO%20DE%20FUNIL_47c2b937._.js.map