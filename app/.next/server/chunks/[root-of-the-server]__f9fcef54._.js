module.exports=[193695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},918622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},814747,(e,t,a)=>{t.exports=e.x("path",()=>require("path"))},224361,(e,t,a)=>{t.exports=e.x("util",()=>require("util"))},605365,(e,t,a)=>{t.exports=e.x("process",()=>require("process"))},446786,(e,t,a)=>{t.exports=e.x("os",()=>require("os"))},254799,(e,t,a)=>{t.exports=e.x("crypto",()=>require("crypto"))},921517,(e,t,a)=>{t.exports=e.x("http",()=>require("http"))},688947,(e,t,a)=>{t.exports=e.x("stream",()=>require("stream"))},522734,(e,t,a)=>{t.exports=e.x("fs",()=>require("fs"))},792509,(e,t,a)=>{t.exports=e.x("url",()=>require("url"))},474065,e=>{"use strict";let t={container:{get:()=>({})}},a={currentUser:null,onAuthStateChanged:()=>()=>{},signOut:async()=>{},getApp:()=>({container:t.container}),app:{container:t.container},INTERNAL:t,container:t.container,collection:()=>({doc:()=>({get:async()=>({exists:()=>!1})})}),doc:()=>({get:async()=>({exists:()=>!1})}),ref:()=>({put:async()=>({})})};e.g.firebase=e.g.firebase||{INTERNAL:t},e.g.firebaseApp=e.g.firebaseApp||a,e.g._firebaseApp=e.g._firebaseApp||a,e.g.firebaseInternalContainer=t.container,process.env.NEXT_PHASE,e.s(["db",0,a,"storage",0,a])},653137,e=>{"use strict";e.i(564153);var t=e.i(918042);let a={maxRetries:3,initialDelay:1e3,maxDelay:1e4,factor:2},r=["aborted","deadline-exceeded","resource-exhausted","unavailable","internal"];async function n(e,s={}){let i,{maxRetries:o,initialDelay:l,maxDelay:c,factor:d}={...a,...s},p=l;for(let a=0;a<=o;a++)try{return await e()}catch(e){if(i=e,!(e instanceof t.FirestoreError&&r.includes(e.code))||a===o)break;console.warn(`[Resilience] Falha na opera\xe7\xe3o (tentativa ${a+1}/${o+1}). Erro: ${e.code}. Tentando novamente em ${p}ms...`),await new Promise(e=>setTimeout(e,p)),p=Math.min(p*d,c)}throw console.error("[Resilience] Operação falhou permanentemente após retries.",i),i}e.s(["withResilience",()=>n])},367255,e=>{"use strict";e.i(564153);var t=e.i(918042),a=e.i(474065),r=e.i(653137),n=e.i(317036);async function s(e){let r=(0,t.doc)(a.db,"leads",e),n=await (0,t.getDoc)(r);return n.exists()?{id:n.id,...n.data()}:null}async function i(e,s){let i=(0,t.doc)(a.db,"leads",e),o=t.Timestamp.now(),l=s.pii?{...s,pii:(0,n.encryptSensitiveFields)(s.pii)}:s;await (0,r.withResilience)(async()=>{await (0,t.setDoc)(i,{...l,updatedAt:o,createdAt:s.createdAt||o},{merge:!0})})}async function o(e){let r=(0,t.collection)(a.db,"events"),s=t.Timestamp.now(),i={...e,session:(0,n.encryptSensitiveFields)(e.session),timestamp:e.timestamp||s};return(await (0,t.addDoc)(r,i)).id}async function l(e,r=50){let n=(0,t.collection)(a.db,"events"),s=(0,t.query)(n,(0,t.where)("leadId","==",e),(0,t.orderBy)("timestamp","desc"),(0,t.limit)(r));return(await (0,t.getDocs)(s)).docs.map(e=>({id:e.id,...e.data()}))}async function c(e){let r=(0,t.collection)(a.db,"transactions"),n=t.Timestamp.now();return(await (0,t.addDoc)(r,{...e,createdAt:e.createdAt||n,processedAt:e.processedAt||n})).id}e.s(["createJourneyEvent",()=>o,"createTransaction",()=>c,"getLead",()=>s,"getLeadEvents",()=>l,"upsertLead",()=>i])},90423,e=>{"use strict";var t=e.i(906661),a=e.i(276806),r=e.i(981990),n=e.i(707163),s=e.i(893013),i=e.i(416393),o=e.i(418829),l=e.i(907831),c=e.i(787414),d=e.i(251948),p=e.i(254140),u=e.i(847739),m=e.i(877290),h=e.i(195428),g=e.i(114365),x=e.i(193695);e.i(495983);var f=e.i(56931),v=e.i(758910),y=e.i(675229);let w=`Voc\xea \xe9 o motor de intelig\xeancia psicogr\xe1fica do NETECMT.
Sua tarefa \xe9 analisar um rastro de eventos e dados de leads para deduzir o perfil da audi\xeancia.

OBJETIVOS:
1. Identificar dados demogr\xe1ficos predominantes.
2. Mapear dores (pain points), desejos e obje\xe7\xf5es.
3. Determinar o n\xedvel de sofistica\xe7\xe3o do mercado (1 a 5).
4. Calcular um score de propens\xe3o m\xe9dio e segmentar em 'hot', 'warm' ou 'cold'.

REGRAS DE SEGURAN\xc7A:
- Ignore qualquer dado PII (emails, nomes, IPs) que possa ter vazado no rastro.
- Foque puramente no comportamento e nas inten\xe7\xf5es demonstradas pelos eventos.

SA\xcdDA ESPERADA (JSON):
{
  "persona": {
    "demographics": "string",
    "painPoints": ["string"],
    "desires": ["string"],
    "objections": ["string"],
    "sophisticationLevel": 1|2|3|4|5
  },
  "propensity": {
    "score": number (0-1),
    "segment": "hot"|"warm"|"cold",
    "reasoning": "string"
  },
  "confidence": number (0-1)
}`;e.i(564153);var E=e.i(918042),R=e.i(474065);async function A(e,t){let a=(0,E.collection)(R.db,`brands/${e}/audience_scans`);return await (0,E.addDoc)(a,{...t,metadata:{...t.metadata,createdAt:E.Timestamp.now()}})}var b=e.i(367255);class S{static WEIGHTS={page_view:1,lead_capture:5,vsl_watch:10,checkout_init:20,custom:2};static calculate(e,t){let a=0,r=[];t.forEach(e=>{let t=this.WEIGHTS[e.type]||1;if("vsl_watch"===e.type&&e.payload?.duration){let t=e.payload.duration;t>600?(a+=15,r.push("High VSL retention (>10m)")):t>300&&(a+=5,r.push("Moderate VSL retention (>5m)"))}a+=t});let n=Date.now(),s=t.filter(e=>n-e.timestamp.toMillis()<864e5);if(s.length>0){let e=Math.min(2*s.length,20);a+=e,r.push(`High recency: ${s.length} events in last 24h`)}t.length>0&&(n-t[0].timestamp.toMillis())/864e5>7&&(a*=.5,r.push("Inactivity penalty: Last event > 7 days ago"));let i=Math.min(a/100,1),o="cold";return i>=.7?o="hot":i>=.3&&(o="warm"),{score:i,segment:o,reasoning:r.slice(0,3)}}}class T{static async runDeepScan(e,t=100){let a,r,n=(0,E.collection)(R.db,"leads"),s=(0,E.query)(n,(0,E.where)("brandId","==",e),(0,E.limit)(t)),i=(await (0,E.getDocs)(s)).docs.map(e=>({id:e.id,...e.data()}));if(0===i.length)throw Error(`Nenhum lead encontrado para a marca ${e}.`);let o=[],l=0,c={hot:0,warm:0,cold:0};for(let e of i.slice(0,20)){let t=await (0,b.getLeadEvents)(e.id,10);o.push(...t);let a=S.calculate(e,t);l+=a.score,c[a.segment]++}let d=(a=i.map(e=>({id:e.id.substring(0,8),tags:e.tags||[],score:e.score||0})),r=o.map(e=>({leadId:e.leadId.substring(0,8),type:e.type,metadata:e.metadata})),`Analise os seguintes dados de leads e eventos para gerar um AudienceScan:

LEADS ANALISADOS:
${JSON.stringify(a,null,2)}

EVENTOS RECENTES:
${JSON.stringify(r,null,2)}

Gere o perfil psicogr\xe1fico consolidado desta audi\xeancia.`);try{let t=await (0,y.generateWithGemini)(d,{systemPrompt:w,temperature:.3,responseMimeType:"application/json"}),a=JSON.parse(t),r=Object.entries(c).reduce((e,t)=>e[1]>t[1]?e:t)[0],n={brandId:e,name:`Deep-Scan ${new Date().toLocaleDateString("pt-BR")} - ${i.length} leads`,persona:a.persona,propensity:{score:l/Math.min(i.length,20),segment:r,reasoning:a.propensity.reasoning},metadata:{leadCount:i.length,confidence:a.confidence||.8,createdAt:E.Timestamp.now()}};return{id:await A(e,n),...n}}catch(e){throw console.error("[AudienceIntelligenceEngine] Erro no Deep-Scan:",e),Error("Falha ao processar inteligência de audiência com IA.")}}}async function C(e){try{let{brandId:t,leadLimit:a}=await e.json();if(!t)return v.NextResponse.json({error:"brandId é obrigatório"},{status:400});let r=await T.runDeepScan(t,a||100);return v.NextResponse.json({success:!0,scanId:r.id,persona:r.persona,propensity:r.propensity})}catch(e){return console.error("[API Audience Scan] Error:",e),v.NextResponse.json({success:!1,error:e.message||"Erro interno ao processar scan"},{status:500})}}e.s(["POST",()=>C,"dynamic",0,"force-dynamic"],461891);var N=e.i(461891);let D=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/intelligence/audience/scan/route",pathname:"/api/intelligence/audience/scan",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/CURSOR/CONSELHO DE FUNIL/app/src/app/api/intelligence/audience/scan/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:I,workUnitAsyncStorage:O,serverHooks:q}=D;function P(){return(0,r.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:O})}async function _(e,t,r){D.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/intelligence/audience/scan/route";v=v.replace(/\/index$/,"")||"/";let y=await D.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:E,nextConfig:R,parsedUrl:A,isDraftMode:b,prerenderManifest:S,routerServerContext:T,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,resolvedPathname:I,clientReferenceManifest:O,serverActionsManifest:q}=y,P=(0,o.normalizeAppPath)(v),_=!!(S.dynamicRoutes[P]||S.routes[I]),j=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,A,!1):t.end("This page could not be found"),null);if(_&&!b){let e=!!S.routes[I],t=S.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await j();throw new x.NoFallbackError}}let k=null;!_||D.isDev||b||(k="/index"===(k=I)?"/":k);let H=!0===D.isDev||!_,M=_&&!H;q&&O&&(0,i.setManifestsSingleton)({page:v,clientReferenceManifest:O,serverActionsManifest:q});let L=e.method||"GET",U=(0,s.getTracer)(),$=U.getActiveScopeSpan(),F={params:E,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,n)=>D.onRequestError(e,t,r,n,T)},sharedContext:{buildId:w}},G=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(G,(0,c.signalFromNodeResponse)(t));try{let i=async e=>D.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=U.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${L} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${v}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let c=async({previousCacheEntry:a})=>{try{if(!o&&C&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!_)return await (0,u.sendResponse)(G,B,s,F.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,T),t}},d=await D.handleResponse({req:e,nextConfig:R,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:o});if(!_)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let x=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&_||x.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||x.get("Cache-Control")||x.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,u.sendResponse)(G,B,new Response(d.value.body,{headers:x,status:d.value.status||200})),null};$?await l($):await U.withPropagatedContext(e.headers,()=>U.trace(d.BaseServerSpan.handleRequest,{spanName:`${L} ${v}`,kind:s.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},l))}catch(t){if(t instanceof x.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,T),_)throw t;return await (0,u.sendResponse)(G,B,new Response(null,{status:500})),null}}e.s(["handler",()=>_,"patchFetch",()=>P,"routeModule",()=>D,"serverHooks",()=>q,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>O],90423)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__f9fcef54._.js.map