{"version":3,"sources":["../../../../../../../../OneDrive/Desktop/CURSOR/CONSELHO%20DE%20FUNIL/app/src/lib/ai/pinecone.ts"],"sourcesContent":["import { type PineconeRecord, type Index } from '@pinecone-database/pinecone';\r\n\r\nconst EXPECTED_DIMENSION = 768; // text-embedding-004\r\n\r\n/**\r\n * Pinecone SDK v6 n√£o aceita mais a propriedade `environment`.\r\n */\r\nfunction getEnv() {\r\n  const apiKey = process.env.PINECONE_API_KEY;\r\n  const indexName = process.env.PINECONE_INDEX || process.env.PINECONE_INDEX_NAME || 'cf-dev-assets';\r\n  const host = process.env.PINECONE_HOST || process.env.PINECONE_HOST_URL;\r\n\r\n  if (!apiKey && typeof window === 'undefined') {\r\n    throw new Error('PINECONE_API_KEY ausente.');\r\n  }\r\n  return { apiKey, indexName, host };\r\n}\r\n\r\nlet cachedClient: any = null;\r\nlet cachedIndex: Index | null = null;\r\n\r\nexport async function getPineconeClient() {\r\n  if (typeof window !== 'undefined') return null;\r\n  if (cachedClient) return cachedClient;\r\n\r\n  const { apiKey } = getEnv();\r\n  const { Pinecone } = await import('@pinecone-database/pinecone');\r\n  cachedClient = new Pinecone({ apiKey: apiKey! });\r\n  return cachedClient;\r\n}\r\n\r\nexport async function getPineconeIndex(): Promise<Index | null> {\r\n  if (typeof window !== 'undefined') return null;\r\n  if (cachedIndex) return cachedIndex;\r\n\r\n  const { indexName, host } = getEnv();\r\n  const client = await getPineconeClient();\r\n  if (!client) return null;\r\n  \r\n  cachedIndex = host ? client.index(indexName, host) : client.index(indexName);\r\n  return cachedIndex;\r\n}\r\n\r\nexport async function upsertToPinecone(\r\n  records: PineconeRecord[],\r\n  options: { namespace?: string } = {}\r\n) {\r\n  if (typeof window !== 'undefined' || !records?.length) return { upserted: 0 };\r\n\r\n  const index = await getPineconeIndex();\r\n  if (!index) return { upserted: 0 };\r\n\r\n  const target = options.namespace ? index.namespace(options.namespace) : index;\r\n  await target.upsert(records);\r\n  return { upserted: records.length };\r\n}\r\n\r\nexport async function queryPinecone(params: {\r\n  vector: number[];\r\n  topK?: number;\r\n  namespace?: string;\r\n  filter?: Record<string, unknown>;\r\n}) {\r\n  if (typeof window !== 'undefined') return { matches: [] };\r\n  \r\n  const { vector, topK = 10, namespace, filter } = params;\r\n  const index = await getPineconeIndex();\r\n  if (!index) return { matches: [] };\r\n\r\n  const target = namespace ? index.namespace(namespace) : index;\r\n  return await target.query({\r\n    vector,\r\n    topK,\r\n    filter,\r\n    includeMetadata: true,\r\n  });\r\n}\r\n\r\nexport async function checkPineconeHealth() {\r\n  if (typeof window !== 'undefined') return null;\r\n  const { indexName } = getEnv();\r\n  const index = await getPineconeIndex();\r\n  const client = await getPineconeClient();\r\n  \r\n  if (!index || !client) return null;\r\n\r\n  const stats = await index.describeIndexStats();\r\n  const description = await client.describeIndex(indexName);\r\n\r\n  return {\r\n    status: 'connected',\r\n    index: indexName,\r\n    totalVectors: stats.totalRecordCount ?? 0,\r\n  };\r\n}\r\n"],"names":[],"mappings":"wCAOA,SAAS,IACP,IAAM,EAAS,QAAQ,GAAG,CAAC,gBAAgB,CACrC,EAAY,QAAQ,GAAG,CAAC,cAAc,EAAI,QAAQ,GAAG,CAAC,mBAAmB,EAAI,gBAC7E,EAAO,QAAQ,GAAG,CAAC,aAAa,EAAI,QAAQ,GAAG,CAAC,iBAAiB,CAEvE,GAAI,CAAC,EACH,MAAM,AAAI,EADG,IACG,6BAElB,MAAO,QAAE,GAHwB,SAGhB,EAAW,EAHkB,IAGb,CACnC,CAEA,IAAI,EAAoB,KACpB,EAA4B,KAEzB,eAAe,IAEpB,GAAI,EAAc,OAAO,EAEzB,GAAM,QAAE,CAAM,CAAE,CAAG,IACb,UAAE,CAAQ,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,QAErB,OADA,AACO,EADQ,IAAI,EAAS,CAAE,OAAQ,CAAQ,EAEhD,CAEO,eAAe,IAEpB,GAAI,EAAa,OAAO,EAExB,GAAM,CAAE,WAAS,MAAE,CAAI,CAAE,CAAG,IACtB,EAAS,MAAM,WACrB,AAAK,EAEL,EAAc,AAFV,EAEiB,EAFR,AAEe,KAAK,CAAC,EAAW,GAAQ,EAAO,KAAK,CAAC,GAF9C,IAItB,CAEO,eAAe,EACpB,CAAyB,CACzB,EAAkC,CAAC,CAAC,EAEpC,GAAqC,CAAjC,AAAkC,GAAS,OAAQ,MAAO,CAAE,SAAU,CAAE,EAE5E,IAAM,EAAQ,MAAM,IACpB,GAAI,CAAC,CAHiB,CAGV,MAAO,CAAE,SAAU,CAAE,EAEjC,IAAM,EAAS,EAAQ,SAAS,CAAG,EAAM,SAAS,CAAC,EAAQ,SAAS,EAAI,EAExE,OADA,MAAM,EAAO,MAAM,CAAC,GACb,CAAE,SAAU,EAAQ,MAAM,AAAC,CACpC,CAEO,eAAe,EAAc,CAKnC,EAGC,GAAM,QAAE,CAAM,CAAE,OAAO,EAAE,WAAE,CAAS,QAAE,CAAM,CAAE,CAAG,EAC3C,EAAQ,MAAM,IACpB,GAAI,CAAC,EAAO,MAAO,CAAE,QAAS,EAAE,AAAC,EAEjC,IAAM,EAAS,EAAY,EAAM,SAAS,CAAC,GAAa,EACxD,OAAO,MAAM,EAAO,KAAK,CAAC,CACxB,SACA,cACA,EACA,iBAAiB,CACnB,EACF,CAEO,eAAe,IAEpB,GAAM,WAAE,CAAS,CAAE,CAAG,IAChB,EAAQ,MAAM,IACd,EAAS,MAAM,IAErB,GAAI,CAAC,GAAS,CAAC,EAAQ,OAAO,KAE9B,IAAM,EAAQ,MAAM,EAAM,kBAAkB,GAG5C,OAFoB,MAAM,EAAO,aAAa,CAAC,GAExC,CACL,OAAQ,YACR,MAAO,EACP,aAAc,EAAM,gBAAgB,EAAI,CAC1C,CACF"}