module.exports=[392977,e=>{"use strict";var t=e.i(758910),r=e.i(254799),a=e.i(813106);class o extends Error{status;constructor(e,t){super(t),this.status=e,this.name="ApiError"}}function n(e,t,a,o){let n=a=>{let o="sha256="+(0,r.createHmac)("sha256",a).update(e).digest("hex");try{return(0,r.timingSafeEqual)(Buffer.from(t),Buffer.from(o))}catch{return!1}};try{if(n(a))return!0;if(o&&n(o))return console.log("[Security] Webhook validado via chave secundária (Graceful Rotation)"),!0;return!1}catch(e){return console.error("[Security] Erro na validação de assinatura:",e),!1}}async function s(e){let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))throw new o(401,"Autenticação necessária (Bearer token ausente)");let r=t.split("Bearer ")[1];try{let e=(process.env.NEXT_PUBLIC_FIREBASE_API_KEY??"").trim();if(!e)throw new o(500,"Configuração do Firebase ausente (API Key)");let t=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:r})});if(!t.ok){let e=await t.json();throw console.error("Firebase Auth REST API Error:",e),new o(401,"Token de autenticação inválido ou expirado")}let n=await t.json(),s=n.users?.[0]?.localId;if(!s)throw new o(401,"Usuário não encontrado no provedor de auth");let i=await (0,a.getUser)(s);if(!i)throw new o(403,"Perfil de usuário não encontrado no banco de dados");if("admin"!==i.role)throw new o(403,"Acesso negado: Requer privilégios de administrador");return i}catch(e){if(e instanceof o)throw e;throw console.error("Security Verification Error:",e),new o(500,"Erro interno na verificação de segurança")}}function i(e){return e instanceof o?t.NextResponse.json({error:e.message},{status:e.status}):(console.error("Unhandled Security Error:",e),t.NextResponse.json({error:"Erro de segurança não especificado"},{status:500}))}e.s(["handleSecurityError",()=>i,"validateWebhookSignature",()=>n,"verifyAdminRole",()=>s])},592775,e=>{"use strict";var t=e.i(906661),r=e.i(276806),a=e.i(981990),o=e.i(707163),n=e.i(893013),s=e.i(416393),i=e.i(418829),u=e.i(907831),l=e.i(787414),d=e.i(251948),c=e.i(254140),p=e.i(847739),h=e.i(877290),f=e.i(195428),R=e.i(114365),m=e.i(193695);e.i(495983);var E=e.i(56931),v=e.i(758910);e.i(564153);var w=e.i(918042),g=e.i(474065),y=e.i(653137),A=e.i(392977);async function C(e){try{let t,r=await e.text(),a=e.headers.get("x-hub-signature-256"),o=process.env.CAMPAIGN_WEBHOOK_SECRET,n=process.env.CAMPAIGN_WEBHOOK_SECRET_SECONDARY;if(!o)return console.error("[Webhook] CAMPAIGN_WEBHOOK_SECRET não configurada no ambiente"),v.NextResponse.json({error:"Configuração de segurança incompleta no servidor"},{status:500});if(!a)return v.NextResponse.json({error:"Assinatura x-hub-signature-256 ausente"},{status:401});if(!(0,A.validateWebhookSignature)(r,a,o,n))return console.warn("[Webhook] Tentativa de acesso com assinatura inválida"),v.NextResponse.json({error:"Assinatura inválida"},{status:401});try{t=JSON.parse(r)}catch(e){return v.NextResponse.json({error:"Payload JSON inválido"},{status:400})}let{campaign_id:s,clicks:i,impressions:u,spend:l,conversions:d}=t;if(!s)return v.NextResponse.json({error:"campaign_id é obrigatório no payload"},{status:400});let c=(0,w.doc)(g.db,"campaigns",s);return await (0,y.withResilience)(async()=>{await (0,w.updateDoc)(c,{metrics:{clicks:Number(i||0),impressions:Number(u||0),spend:Number(l||0),conversions:Number(d||0),lastUpdated:w.Timestamp.now()},updatedAt:w.Timestamp.now()})}),console.log(`[Webhook] ✅ M\xe9tricas sincronizadas para campanha: ${s}`),v.NextResponse.json({success:!0,message:"Métricas atualizadas com sucesso",timestamp:new Date().toISOString()})}catch(e){return console.error("[Webhook] Erro crítico ao processar webhook:",e),v.NextResponse.json({error:"Erro interno ao processar métricas de ads",details:e.message},{status:500})}}e.s(["POST",()=>C,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],782198);var x=e.i(782198);let b=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/webhooks/ads-metrics/route",pathname:"/api/webhooks/ads-metrics",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/CURSOR/CONSELHO DE FUNIL/app/src/app/api/webhooks/ads-metrics/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:N,workUnitAsyncStorage:S,serverHooks:O}=b;function T(){return(0,a.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:S})}async function P(e,t,a){b.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/webhooks/ads-metrics/route";v=v.replace(/\/index$/,"")||"/";let w=await b.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:g,params:y,nextConfig:A,parsedUrl:C,isDraftMode:x,prerenderManifest:N,routerServerContext:S,isOnDemandRevalidate:O,revalidateOnlyGenerated:T,resolvedPathname:P,clientReferenceManifest:k,serverActionsManifest:_}=w,I=(0,i.normalizeAppPath)(v),U=!!(N.dynamicRoutes[I]||N.routes[P]),H=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,C,!1):t.end("This page could not be found"),null);if(U&&!x){let e=!!N.routes[P],t=N.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await H();throw new m.NoFallbackError}}let j=null;!U||b.isDev||x||(j="/index"===(j=P)?"/":j);let D=!0===b.isDev||!U,M=U&&!D;_&&k&&(0,s.setManifestsSingleton)({page:v,clientReferenceManifest:k,serverActionsManifest:_});let q=e.method||"GET",B=(0,n.getTracer)(),K=B.getActiveScopeSpan(),W={params:y,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,o)=>b.onRequestError(e,t,a,o,S)},sharedContext:{buildId:g}},F=new u.NodeNextRequest(e),$=new u.NodeNextResponse(t),L=l.NextRequestAdapter.fromNodeNextRequest(F,(0,l.signalFromNodeResponse)(t));try{let s=async e=>b.handle(L,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${v}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),u=async o=>{var n,u;let l=async({previousCacheEntry:r})=>{try{if(!i&&O&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(o);e.fetchMetrics=W.renderOpts.fetchMetrics;let u=W.renderOpts.pendingWaitUntil;u&&a.waitUntil&&(a.waitUntil(u),u=void 0);let l=W.renderOpts.collectedTags;if(!U)return await (0,p.sendResponse)(F,$,n,W.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[R.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,a=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:O})},!1,S),t}},d=await b.handleResponse({req:e,nextConfig:A,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:T,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:i});if(!U)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",O?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&U||m.delete(R.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(F,$,new Response(d.value.body,{headers:m,status:d.value.status||200})),null};K?await u(K):await B.withPropagatedContext(e.headers,()=>B.trace(d.BaseServerSpan.handleRequest,{spanName:`${q} ${v}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},u))}catch(t){if(t instanceof m.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:O})},!1,S),U)throw t;return await (0,p.sendResponse)(F,$,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>T,"routeModule",()=>b,"serverHooks",()=>O,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>S],592775)}];

//# sourceMappingURL=OneDrive_Desktop_CURSOR_CONSELHO%20DE%20FUNIL_8ebcac06._.js.map