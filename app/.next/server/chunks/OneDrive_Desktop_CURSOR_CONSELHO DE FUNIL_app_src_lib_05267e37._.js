module.exports=[653137,e=>{"use strict";e.i(564153);var t=e.i(918042);let a={maxRetries:3,initialDelay:1e3,maxDelay:1e4,factor:2},n=["aborted","deadline-exceeded","resource-exhausted","unavailable","internal"];async function r(e,o={}){let i,{maxRetries:s,initialDelay:c,maxDelay:d,factor:u}={...a,...o},l=c;for(let a=0;a<=s;a++)try{return await e()}catch(e){if(i=e,!(e instanceof t.FirestoreError&&n.includes(e.code))||a===s)break;console.warn(`[Resilience] Falha na opera\xe7\xe3o (tentativa ${a+1}/${s+1}). Erro: ${e.code}. Tentando novamente em ${l}ms...`),await new Promise(e=>setTimeout(e,l)),l=Math.min(l*u,d)}throw console.error("[Resilience] Operação falhou permanentemente após retries.",i),i}e.s(["withResilience",()=>r])},813106,e=>{"use strict";e.i(564153);var t=e.i(918042),a=e.i(474065),n=e.i(653137);async function r(e){let n=(0,t.doc)(a.db,"users",e),r=await (0,t.getDoc)(n);return r.exists()?r.data().credits??0:0}async function o(e,n=-1){let r=(0,t.doc)(a.db,"users",e);await (0,t.updateDoc)(r,{credits:(0,t.increment)(n),usage:(0,t.increment)(Math.abs(n))})}async function i(e){let n=(0,t.doc)(a.db,"users",e),r=await (0,t.getDoc)(n);return r.exists()?{id:r.id,...r.data()}:null}async function s(e){let n=(0,t.doc)(a.db,"funnels",e),r=await (0,t.getDoc)(n);return r.exists()?{id:r.id,...r.data()}:null}async function c(e){let n=(0,t.query)((0,t.collection)(a.db,"funnels"),(0,t.where)("userId","==",e));return(await (0,t.getDocs)(n)).docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>{let a=e.updatedAt?.seconds||0;return(t.updatedAt?.seconds||0)-a})}async function d(e,r){let o=(0,t.doc)(a.db,"funnels",e);await (0,n.withResilience)(async()=>{await (0,t.updateDoc)(o,{...r,updatedAt:t.Timestamp.now()})})}async function u(e,n){return(await (0,t.addDoc)((0,t.collection)(a.db,"funnels",e,"proposals"),{...n,funnelId:e,createdAt:t.Timestamp.now()})).id}async function l(e){let n=(0,t.query)((0,t.collection)(a.db,"funnels",e,"proposals"),(0,t.orderBy)("version","desc"));return(await (0,t.getDocs)(n)).docs.map(e=>({id:e.id,...e.data()}))}async function f(e){let n=(0,t.doc)(a.db,"conversations",e),r=await (0,t.getDoc)(n);return r.exists()?{id:r.id,...r.data()}:null}async function w(e,r){let o=(0,t.doc)(a.db,"conversations",e);await (0,n.withResilience)(async()=>{await (0,t.updateDoc)(o,{...r,updatedAt:t.Timestamp.now()})})}async function p(e,n){let r=await (0,t.addDoc)((0,t.collection)(a.db,"conversations",e,"messages"),{...n,conversationId:e,createdAt:t.Timestamp.now()});return await w(e,{}),r.id}async function m(e){let n=(0,t.doc)(a.db,"brands",e),r=await (0,t.getDoc)(n);return r.exists()?{id:r.id,...r.data()}:null}async function h(e){let n=(0,t.doc)(a.db,"campaigns",e),r=await (0,t.getDoc)(n);return r.exists()?{id:r.id,...r.data()}:null}async function g(e,r){let o=(0,t.doc)(a.db,"campaigns",e);return await (0,n.withResilience)(async()=>{await (0,t.setDoc)(o,{...r,updatedAt:t.Timestamp.now()},{merge:!0})})}e.i(317036),e.s(["addMessage",()=>p,"createProposal",()=>u,"getBrand",()=>m,"getCampaign",()=>h,"getConversation",()=>f,"getFunnel",()=>s,"getFunnelProposals",()=>l,"getUser",()=>i,"getUserCredits",()=>r,"getUserFunnels",()=>c,"updateCampaignManifesto",()=>g,"updateConversation",()=>w,"updateFunnel",()=>d,"updateUserUsage",()=>o])},392977,e=>{"use strict";var t=e.i(758910),a=e.i(254799),n=e.i(813106);class r extends Error{status;constructor(e,t){super(t),this.status=e,this.name="ApiError"}}function o(e,t,n,r){let o=n=>{let r="sha256="+(0,a.createHmac)("sha256",n).update(e).digest("hex");try{return(0,a.timingSafeEqual)(Buffer.from(t),Buffer.from(r))}catch{return!1}};try{if(o(n))return!0;if(r&&o(r))return console.log("[Security] Webhook validado via chave secundária (Graceful Rotation)"),!0;return!1}catch(e){return console.error("[Security] Erro na validação de assinatura:",e),!1}}async function i(e){let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))throw new r(401,"Autenticação necessária (Bearer token ausente)");let a=t.split("Bearer ")[1];try{let e=(process.env.NEXT_PUBLIC_FIREBASE_API_KEY??"").trim();if(!e)throw new r(500,"Configuração do Firebase ausente (API Key)");let t=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:a})});if(!t.ok){let e=await t.json();throw console.error("Firebase Auth REST API Error:",e),new r(401,"Token de autenticação inválido ou expirado")}let o=await t.json(),i=o.users?.[0]?.localId;if(!i)throw new r(401,"Usuário não encontrado no provedor de auth");let s=await (0,n.getUser)(i);if(!s)throw new r(403,"Perfil de usuário não encontrado no banco de dados");if("admin"!==s.role)throw new r(403,"Acesso negado: Requer privilégios de administrador");return s}catch(e){if(e instanceof r)throw e;throw console.error("Security Verification Error:",e),new r(500,"Erro interno na verificação de segurança")}}function s(e){return e instanceof r?t.NextResponse.json({error:e.message},{status:e.status}):(console.error("Unhandled Security Error:",e),t.NextResponse.json({error:"Erro de segurança não especificado"},{status:500}))}e.s(["handleSecurityError",()=>s,"validateWebhookSignature",()=>o,"verifyAdminRole",()=>i])}];

//# sourceMappingURL=OneDrive_Desktop_CURSOR_CONSELHO%20DE%20FUNIL_app_src_lib_05267e37._.js.map