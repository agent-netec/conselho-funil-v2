module.exports=[193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},814747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},224361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},605365,(e,t,r)=>{t.exports=e.x("process",()=>require("process"))},446786,(e,t,r)=>{t.exports=e.x("os",()=>require("os"))},254799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},688947,(e,t,r)=>{t.exports=e.x("stream",()=>require("stream"))},921517,(e,t,r)=>{t.exports=e.x("http",()=>require("http"))},522734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},792509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},653936,e=>{"use strict";var t=e.i(346414);e.i(564153);var r=e.i(918042),a=e.i(474065);function n(){let e=(process.env.NEXT_PUBLIC_GOOGLE_AI_API_KEY??"").trim(),t=(process.env.GOOGLE_AI_API_KEY??"").trim();return e||t}async function s(e){let t=new TextEncoder().encode(e.trim().toLowerCase());return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}async function o(e){let t=n();if(!t)throw Error("GOOGLE_AI_API_KEY not configured for embeddings");let o=Date.now(),i=await s(e);try{let e=(0,r.doc)(a.db,"query_cache",i),t=await (0,r.getDoc)(e);if(t.exists()){let e=t.data();if(!(r.Timestamp.now().toMillis()-e.createdAt.toMillis()>2592e6))return console.log(`[Embeddings] Cache HIT for key: ${i.substring(0,8)} (${Date.now()-o}ms)`),e.embedding}}catch(e){console.warn("[Embeddings] Cache read error:",e)}try{console.log("[Embeddings] Calling text-embedding-004 with dimensionality: 768");let n=await fetch("https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify({model:"models/text-embedding-004",content:{parts:[{text:e}]},outputDimensionality:768})});if(!n.ok){let e=await n.text();throw Error(`Embedding API failed: ${n.status} ${e}`)}let s=await n.json(),l=s?.embedding?.values;if(!Array.isArray(l))throw Error("Embedding API returned no values");let d=(0,r.doc)(a.db,"query_cache",i);return(0,r.setDoc)(d,{query:e.substring(0,500),embedding:l,createdAt:r.Timestamp.now()}).catch(e=>console.error("[Embeddings] Cache write error:",e)),console.log(`[Embeddings] Cache MISS - API called (${Date.now()-o}ms)`),l}catch(e){throw console.error("[Embeddings] Error generating embedding:",e),e}}async function i(e){let o=Date.now(),i=Array(e.length).fill(null),l=[],d=[],c=r.Timestamp.now().toMillis();for(let t=0;t<e.length;t++){let n=e[t],o=await s(n);try{let e=(0,r.doc)(a.db,"query_cache",o),n=await (0,r.getDoc)(e);if(n.exists()){let e=n.data();if(!(c-e.createdAt.toMillis()>2592e6)){i[t]=e.embedding;continue}}}catch(e){}l.push(t),d.push(n)}if(0===d.length)return console.log(`[Embeddings] Batch Cache HIT (100%) - ${e.length} items (${Date.now()-o}ms)`),i;let u=n();if(!u)throw Error("GOOGLE_AI_API_KEY not configured for embeddings");new t.GoogleGenerativeAI(u).getGenerativeModel({model:"text-embedding-004"});try{console.log(`[Embeddings] Batch Cache MISS - Calling API for ${d.length}/${e.length} items`);let t=[];for(let e=0;e<d.length;e+=90){let r=d.slice(e,e+90);console.log(`[Embeddings] Processing API sub-batch ${e/90+1} (${r.length} items)`);let a=await fetch("https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:batchEmbedContents",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":u},body:JSON.stringify({requests:r.map(e=>({model:"models/text-embedding-004",content:{parts:[{text:e}]},outputDimensionality:768}))})});if(!a.ok){let e=await a.text();throw Error(`Batch Embedding API failed: ${a.status} ${e}`)}let n=await a.json();if(!n.embeddings||!Array.isArray(n.embeddings))throw Error("Batch Embedding API returned invalid format");t.push(...n.embeddings.map(e=>e.values))}for(let e=0;e<l.length;e++){let n=l[e],o=t[e],c=d[e];i[n]=o;let u=await s(c),p=(0,r.doc)(a.db,"query_cache",u);(0,r.setDoc)(p,{query:c.substring(0,500),embedding:o,createdAt:r.Timestamp.now()}).catch(e=>console.error("[Embeddings] Cache write error:",e))}return console.log(`[Embeddings] Batch completed (${Date.now()-o}ms)`),i}catch(e){throw console.error("[Embeddings] Error generating batch embeddings:",e),e}}e.s(["generateEmbedding",()=>o,"generateEmbeddingsBatch",()=>i])},413263,e=>{"use strict";function t(){let e=process.env.PINECONE_API_KEY,t=process.env.PINECONE_INDEX||process.env.PINECONE_INDEX_NAME||"cf-dev-assets",r=process.env.PINECONE_HOST||process.env.PINECONE_HOST_URL;if(!e)throw Error("PINECONE_API_KEY ausente.");return{apiKey:e,indexName:t,host:r}}let r=null,a=null;async function n(){if(r)return r;let{apiKey:a}=t(),{Pinecone:n}=await e.A(465660);return r=new n({apiKey:a})}async function s(){if(a)return a;let{indexName:e,host:r}=t(),s=await n();return s?a=r?s.index(e,r):s.index(e):null}async function o(e,t={}){if(!e?.length)return{upserted:0};let r=await s();if(!r)return{upserted:0};let a=t.namespace?r.namespace(t.namespace):r;return await a.upsert(e),{upserted:e.length}}async function i(e){let{vector:t,topK:r=10,namespace:a,filter:n}=e,o=await s();if(!o)return{matches:[]};let i=a?o.namespace(a):o;return await i.query({vector:t,topK:r,filter:n,includeMetadata:!0})}async function l(){let{indexName:e}=t(),r=await s(),a=await n();if(!r||!a)return null;let o=await r.describeIndexStats();return await a.describeIndex(e),{status:"connected",index:e,totalVectors:o.totalRecordCount??0}}e.s(["checkPineconeHealth",()=>l,"getPineconeClient",()=>n,"getPineconeIndex",()=>s,"queryPinecone",()=>i,"upsertToPinecone",()=>o])},569157,e=>{"use strict";e.i(564153);var t=e.i(918042),r=e.i(474065);e.i(653137),e.i(653936),e.i(413263);var a=e.i(317036);class n{static getCollectionPath(e){return`brands/${e}/secrets`}static async saveToken(e,n){let s=(0,t.doc)(r.db,this.getCollectionPath(e),`token_${n.provider}`),o={...n,accessToken:(0,a.encrypt)(n.accessToken),refreshToken:n.refreshToken?(0,a.encrypt)(n.refreshToken):void 0,updatedAt:t.Timestamp.now()};await (0,t.setDoc)(s,o)}static async getToken(e,n){let s=(0,t.doc)(r.db,this.getCollectionPath(e),`token_${n}`),o=await (0,t.getDoc)(s);if(!o.exists())return null;let i=o.data();return{...i,accessToken:(0,a.decrypt)(i.accessToken),refreshToken:i.refreshToken?(0,a.decrypt)(i.refreshToken):void 0}}static isTokenExpiring(e){let t=Date.now();return e.expiresAt.toMillis()-t<864e5}}e.s(["MonaraTokenVault",()=>n],569157)},295162,e=>{"use strict";var t=e.i(906661),r=e.i(276806),a=e.i(981990),n=e.i(707163),s=e.i(893013),o=e.i(416393),i=e.i(418829),l=e.i(907831),d=e.i(787414),c=e.i(251948),u=e.i(254140),p=e.i(847739),m=e.i(877290),h=e.i(195428),g=e.i(114365),f=e.i(193695);e.i(495983);var w=e.i(56931),x=e.i(758910),E=e.i(392977),b=e.i(569157);e.i(564153);var v=e.i(918042);class y{static normalize(e){let{platform:t,payload:r}=e;switch(t){case"instagram":return this.normalizeInstagram(r);case"meta":return this.normalizeMeta(r);default:throw Error(`Plataforma ${t} n\xe3o suportada pelo normalizador.`)}}static normalizeInstagram(e){let t=e.entry?.[0],r=t?.messaging?.[0],a=t?.changes?.[0]?.value;if(r)return{leadId:r.sender.id,interaction:{type:"dm_received",platform:"instagram",timestamp:v.Timestamp.now(),metadata:{text:r.message?.text}}};if(a)return{leadId:a.from.id,interaction:{type:"comment_made",platform:"instagram",timestamp:v.Timestamp.now(),metadata:{text:a.text,mediaId:a.media?.id}}};throw Error("Payload Instagram inválido ou não reconhecido.")}static normalizeMeta(e){let t=e.entry?.[0]?.changes?.[0];if(t?.field==="leadgen")return{leadId:t.value.leadgen_id,interaction:{type:"ad_click",platform:"meta",timestamp:v.Timestamp.now(),metadata:{formId:t.value.form_id}}};throw Error("Payload Meta Ads inválido ou não reconhecido.")}}var A=e.i(474065);class R{static async getLeadContext(e,t){let r=(0,v.doc)(A.db,`brands/${e}/leads`,t),a=await (0,v.getDoc)(r);return a.exists()?{id:a.id,...a.data()}:null}static async processInteraction(e,t,r){let a=(0,v.doc)(A.db,`brands/${e}/leads`,t),n=await this.getLeadContext(e,t);if(!n){let t={brandId:e,currentAwareness:"UNAWARE",lastInteraction:r,tags:[],score:10,metadata:{},updatedAt:v.Timestamp.now()};await (0,v.setDoc)(a,t);return}let s=n.currentAwareness,o=n.score,i=5;"ad_click"===r.type&&(i=10),"dm_received"===r.type&&(i=15);let l=o+i;l>80?s="MOST_AWARE":l>60?s="PRODUCT_AWARE":l>40?s="SOLUTION_AWARE":l>20&&(s="PROBLEM_AWARE"),await (0,v.updateDoc)(a,{currentAwareness:s,lastInteraction:r,score:l,updatedAt:v.Timestamp.now()});let d=(0,v.collection)(A.db,`brands/${e}/leads/${t}/events`);await (0,v.addDoc)(d,{...r,awarenessAtTime:s,timestamp:v.Timestamp.now()})}}async function _(e){let t=e.nextUrl.pathname.split("/").pop(),r=e.nextUrl.searchParams.get("brandId");if(!r)return x.NextResponse.json({error:"brandId is required"},{status:400});try{let a=await e.text(),n=e.headers.get("x-hub-signature-256")||e.headers.get("x-hub-signature"),s=await b.MonaraTokenVault.getToken(r,"instagram"===t?"meta":t),o=s?.metadata?.clientSecret;if(!o)return console.error(`[Webhook] ClientSecret not found for brand ${r} on platform ${t}`),x.NextResponse.json({error:"Configuration missing"},{status:500});if(n&&!(0,E.validateWebhookSignature)(a,n,o))return x.NextResponse.json({error:"Invalid signature"},{status:401});let i=JSON.parse(a),{leadId:l,interaction:d}=y.normalize({platform:t,brandId:r,payload:i});return await R.processInteraction(r,l,d),x.NextResponse.json({success:!0})}catch(e){return console.error(`[Webhook Error] ${t}:`,e),x.NextResponse.json({error:"Internal processing error",details:e.message},{status:500})}}async function C(e){let{searchParams:t}=new URL(e.url),r=t.get("hub.mode"),a=t.get("hub.verify_token"),n=t.get("hub.challenge");return"subscribe"===r&&a?new x.NextResponse(n,{status:200}):x.NextResponse.json({error:"Forbidden"},{status:403})}e.s(["GET",()=>C,"POST",()=>_],712050);var T=e.i(712050);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/webhooks/dispatcher/route",pathname:"/api/webhooks/dispatcher",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/CURSOR/CONSELHO DE FUNIL/app/src/app/api/webhooks/dispatcher/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:P,workUnitAsyncStorage:k,serverHooks:N}=I;function O(){return(0,a.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:k})}async function S(e,t,a){I.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/webhooks/dispatcher/route";x=x.replace(/\/index$/,"")||"/";let E=await I.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:b,params:v,nextConfig:y,parsedUrl:A,isDraftMode:R,prerenderManifest:_,routerServerContext:C,isOnDemandRevalidate:T,revalidateOnlyGenerated:P,resolvedPathname:k,clientReferenceManifest:N,serverActionsManifest:O}=E,S=(0,i.normalizeAppPath)(x),q=!!(_.dynamicRoutes[S]||_.routes[k]),D=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,A,!1):t.end("This page could not be found"),null);if(q&&!R){let e=!!_.routes[k],t=_.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await D();throw new f.NoFallbackError}}let $=null;!q||I.isDev||R||($="/index"===($=k)?"/":$);let j=!0===I.isDev||!q,M=q&&!j;O&&N&&(0,o.setManifestsSingleton)({page:x,clientReferenceManifest:N,serverActionsManifest:O});let U=e.method||"GET",H=(0,s.getTracer)(),L=H.getActiveScopeSpan(),G={params:v,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>I.onRequestError(e,t,a,n,C)},sharedContext:{buildId:b}},K=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),F=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let o=async e=>I.handle(F,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${x}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!i&&T&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(n);e.fetchMetrics=G.renderOpts.fetchMetrics;let l=G.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=G.renderOpts.collectedTags;if(!q)return await (0,p.sendResponse)(K,B,s,G.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,a=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})},!1,C),t}},c=await I.handleResponse({req:e,nextConfig:y,cacheKey:$,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:P,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:i});if(!q)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),R&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&q||f.delete(g.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(K,B,new Response(c.value.body,{headers:f,status:c.value.status||200})),null};L?await l(L):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${U} ${x}`,kind:s.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})},!1,C),q)throw t;return await (0,p.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>O,"routeModule",()=>I,"serverHooks",()=>N,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>k],295162)},465660,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__a13a3d25._.js","server/chunks/5c86f_@pinecone-database_pinecone_dist_b1d5c4a9._.js"].map(t=>e.l(t))).then(()=>t(432229)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__091ef1d5._.js.map