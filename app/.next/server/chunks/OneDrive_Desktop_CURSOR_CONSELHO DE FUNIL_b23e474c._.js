module.exports=[392977,e=>{"use strict";var t=e.i(758910),r=e.i(254799),a=e.i(813106);class n extends Error{status;constructor(e,t){super(t),this.status=e,this.name="ApiError"}}function i(e,t,a,n){let i=a=>{let n="sha256="+(0,r.createHmac)("sha256",a).update(e).digest("hex");try{return(0,r.timingSafeEqual)(Buffer.from(t),Buffer.from(n))}catch{return!1}};try{if(i(a))return!0;if(n&&i(n))return console.log("[Security] Webhook validado via chave secundária (Graceful Rotation)"),!0;return!1}catch(e){return console.error("[Security] Erro na validação de assinatura:",e),!1}}async function o(e){let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))throw new n(401,"Autenticação necessária (Bearer token ausente)");let r=t.split("Bearer ")[1];try{let e=(process.env.NEXT_PUBLIC_FIREBASE_API_KEY??"").trim();if(!e)throw new n(500,"Configuração do Firebase ausente (API Key)");let t=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:r})});if(!t.ok){let e=await t.json();throw console.error("Firebase Auth REST API Error:",e),new n(401,"Token de autenticação inválido ou expirado")}let i=await t.json(),o=i.users?.[0]?.localId;if(!o)throw new n(401,"Usuário não encontrado no provedor de auth");let s=await (0,a.getUser)(o);if(!s)throw new n(403,"Perfil de usuário não encontrado no banco de dados");if("admin"!==s.role)throw new n(403,"Acesso negado: Requer privilégios de administrador");return s}catch(e){if(e instanceof n)throw e;throw console.error("Security Verification Error:",e),new n(500,"Erro interno na verificação de segurança")}}function s(e){return e instanceof n?t.NextResponse.json({error:e.message},{status:e.status}):(console.error("Unhandled Security Error:",e),t.NextResponse.json({error:"Erro de segurança não especificado"},{status:500}))}e.s(["handleSecurityError",()=>s,"validateWebhookSignature",()=>i,"verifyAdminRole",()=>o])},367255,e=>{"use strict";e.i(564153);var t=e.i(918042),r=e.i(474065),a=e.i(653137),n=e.i(317036);async function i(e){let a=(0,t.doc)(r.db,"leads",e),n=await (0,t.getDoc)(a);return n.exists()?{id:n.id,...n.data()}:null}async function o(e,i){let o=(0,t.doc)(r.db,"leads",e),s=t.Timestamp.now(),l=i.pii?{...i,pii:(0,n.encryptSensitiveFields)(i.pii)}:i;await (0,a.withResilience)(async()=>{await (0,t.setDoc)(o,{...l,updatedAt:s,createdAt:i.createdAt||s},{merge:!0})})}async function s(e){let a=(0,t.collection)(r.db,"events"),i=t.Timestamp.now(),o={...e,session:(0,n.encryptSensitiveFields)(e.session),timestamp:e.timestamp||i};return(await (0,t.addDoc)(a,o)).id}async function l(e,a=50){let n=(0,t.collection)(r.db,"events"),i=(0,t.query)(n,(0,t.where)("leadId","==",e),(0,t.orderBy)("timestamp","desc"),(0,t.limit)(a));return(await (0,t.getDocs)(i)).docs.map(e=>({id:e.id,...e.data()}))}async function u(e){let a=(0,t.collection)(r.db,"transactions"),n=t.Timestamp.now();return(await (0,t.addDoc)(a,{...e,createdAt:e.createdAt||n,processedAt:e.processedAt||n})).id}e.s(["createJourneyEvent",()=>s,"createTransaction",()=>u,"getLead",()=>i,"getLeadEvents",()=>l,"upsertLead",()=>o])},985541,e=>{"use strict";e.i(564153);var t=e.i(918042);function r(e){let r=e instanceof t.Timestamp?e.toDate():e,a=r.getFullYear(),n=String(r.getMonth()+1).padStart(2,"0");return`${a}-${n}`}e.i(367255),e.s(["generateCohortId",()=>r])},954539,e=>{"use strict";var t=e.i(906661),r=e.i(276806),a=e.i(981990),n=e.i(707163),i=e.i(893013),o=e.i(416393),s=e.i(418829),l=e.i(907831),u=e.i(787414),d=e.i(251948),c=e.i(254140),p=e.i(847739),h=e.i(877290),m=e.i(195428),f=e.i(114365),g=e.i(193695);e.i(495983);var v=e.i(56931),w=e.i(758910);e.i(564153);var R=e.i(918042),E=e.i(325138),y=e.i(367255),A=e.i(985541);async function C(e){let{email:t,type:r,source:a,payload:n,session:i}=e,o=E.default.SHA256(t.toLowerCase().trim()).toString(),s=R.Timestamp.now(),l=await (0,y.getLead)(o),u=!l,d=i?.utmSource||"direct",c=i?.utmMedium||"none",p=i?.utmCampaign||"none";if(u){let e=(0,A.generateCohortId)(s),r={pii:{email:t.toLowerCase().trim()},attribution:{firstSource:d,firstMedium:c,firstCampaign:p,lastSource:d,lastMedium:c,lastCampaign:p},metrics:{totalLtv:0,transactionCount:0,averageTicket:0,cohort:e},status:"lead",createdAt:s,updatedAt:s};await (0,y.upsertLead)(o,r)}else i?.utmSource&&await (0,y.upsertLead)(o,{attribution:{...l.attribution,lastSource:d,lastMedium:c,lastCampaign:p}});let h={leadId:o,type:r,source:a,payload:n||{},session:{sessionId:i?.sessionId||"unknown",utmSource:d,utmMedium:c,utmCampaign:p,ipAddress:i?.ipAddress},timestamp:s};return{leadId:o,eventId:await (0,y.createJourneyEvent)(h),isNewLead:u}}var S=e.i(392977);async function x(e){try{let t=await e.json();if(!t.email||!t.type||!t.source)return w.NextResponse.json({error:"Campos obrigatórios ausentes: email, type, source."},{status:400});let r=await C(t);return w.NextResponse.json({success:!0,...r})}catch(e){if(console.error("[Event Ingest Error]:",e),e.status)return(0,S.handleSecurityError)(e);return w.NextResponse.json({error:"Erro interno ao processar evento."},{status:500})}}e.s(["POST",()=>x,"dynamic",0,"force-dynamic"],702992);var T=e.i(702992);let b=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/intelligence/events/ingest/route",pathname:"/api/intelligence/events/ingest",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/CURSOR/CONSELHO DE FUNIL/app/src/app/api/intelligence/events/ingest/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:N,workUnitAsyncStorage:P,serverHooks:I}=b;function O(){return(0,a.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:P})}async function k(e,t,a){b.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/intelligence/events/ingest/route";w=w.replace(/\/index$/,"")||"/";let R=await b.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:y,nextConfig:A,parsedUrl:C,isDraftMode:S,prerenderManifest:x,routerServerContext:T,isOnDemandRevalidate:N,revalidateOnlyGenerated:P,resolvedPathname:I,clientReferenceManifest:O,serverActionsManifest:k}=R,_=(0,s.normalizeAppPath)(w),D=!!(x.dynamicRoutes[_]||x.routes[I]),U=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,C,!1):t.end("This page could not be found"),null);if(D&&!S){let e=!!x.routes[I],t=x.dynamicRoutes[_];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await U();throw new g.NoFallbackError}}let H=null;!D||b.isDev||S||(H="/index"===(H=I)?"/":H);let q=!0===b.isDev||!D,L=D&&!q;k&&O&&(0,o.setManifestsSingleton)({page:w,clientReferenceManifest:O,serverActionsManifest:k});let M=e.method||"GET",j=(0,i.getTracer)(),F=j.getActiveScopeSpan(),B={params:y,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>b.onRequestError(e,t,a,n,T)},sharedContext:{buildId:E}},$=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),W=u.NextRequestAdapter.fromNodeNextRequest($,(0,u.signalFromNodeResponse)(t));try{let o=async e=>b.handle(W,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${w}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let u=async({previousCacheEntry:r})=>{try{if(!s&&N&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=B.renderOpts.collectedTags;if(!D)return await (0,p.sendResponse)($,K,i,B.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:N})},!1,T),t}},d=await b.handleResponse({req:e,nextConfig:A,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:P,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:s});if(!D)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",N?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&D||g.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)($,K,new Response(d.value.body,{headers:g,status:d.value.status||200})),null};F?await l(F):await j.withPropagatedContext(e.headers,()=>j.trace(d.BaseServerSpan.handleRequest,{spanName:`${M} ${w}`,kind:i.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:N})},!1,T),D)throw t;return await (0,p.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>k,"patchFetch",()=>O,"routeModule",()=>b,"serverHooks",()=>I,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>P],954539)}];

//# sourceMappingURL=OneDrive_Desktop_CURSOR_CONSELHO%20DE%20FUNIL_b23e474c._.js.map